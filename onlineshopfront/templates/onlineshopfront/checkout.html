{% extends "onlineshopfront/base.html" %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-card">
        <h2>Checkout</h2>

        {% if not items %}
        <p>Your cart is empty. <a href="{% url 'onlineshopfront:product_list' %}">Continue shopping</a></p>
        {% else %}

        <div class="checkout-grid">
            <div class="checkout-left">
                <table class="checkout-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for it in items %}
                        <tr>
                            <td class="product-cell">{{ it.name }}
                            </td>
                            <td class="numeric">${{ it.price }}</td>
                            <td class="numeric">{{ it.quantity }}</td>
                            <td class="numeric">${{ it.subtotal|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <form method="post" action="{% url 'onlineshopfront:checkout' %}" class="checkout-form">
                    {% csrf_token %}
                    <div class="form-section">
                        <h3>Delivery address</h3>
                        <div class="form-grid">
                            <label class="form-field full">
                                <div class="field-label">Address</div>
                                <textarea name="address"
                                    class="input textarea">{{ form.address.value|default_if_none:"" }}</textarea>
                            </label>

                            <label class="form-field">
                                <div class="field-label">Postal / ZIP</div>
                                <input name="postal_code" class="input"
                                    value="{{ form.postal_code.value|default_if_none:""}}" />
                            </label>

                            <label class="form-field">
                                <div class="field-label">Phone</div>
                                <input name="phone" class="input" value="{{ form.phone.value|default_if_none:""}}" />
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Payment</h3>
                        <div class="radio-list">
                            <label><input type="radio" name="payment_method" value="Card" {% if form.payment_method == 'Card' %}checked{% endif %}> Card</label>
                            <label><input type="radio" name="payment_method" value="Paynow" {% if form.payment_method == 'Paynow' %}checked{% endif %}> Paynow</label>
                        </div>

                        <div id="card-fields" class="card-fields">
                            <div class="form-grid card-grid">
                                <label class="form-field full">
                                    <div class="field-label">Card number</div>
                                    <input name="card_number" class="input" value="{{ form.card_number }}" />
                                </label>

                                <label class="form-field small">
                                    <div class="field-label">Exp month</div>
                                    <input name="card_exp_month" class="input" value="{{ form.card_exp_month }}" />
                                </label>

                                <label class="form-field small">
                                    <div class="field-label">Exp year</div>
                                    <input name="card_exp_year" class="input" value="{{ form.card_exp_year }}" />
                                </label>

                                <label class="form-field small">
                                    <div class="field-label">CVV</div>
                                    <input name="card_cvv" class="input" value="" autocomplete="off" />
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="place-order-btn">Place order</button>
                        <a class="link-muted" href="{% url 'onlineshopfront:view_cart' %}">Edit cart</a>
                    </div>
                </form>
            </div>

            <aside class="checkout-right">
                <div class="summary">
                    <div class="summary-row total"><span>Total</span><span>${{ total|floatformat:2 }}</span></div>
                </div>

                {% comment %} 
                =================================================
                SECTION: AI "Complete Your Set" (Newly Added)
                =================================================
                {% endcomment %}
                {% if recommended_products %}
                <div class="recommendation-section" style="margin-top:20px;padding:12px;background:#f9f9f9;border-radius:8px">
                    
                    <h3 style="margin:0 0 12px 0;font-size: 1em;">Complete Your Set</h3>
                    
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        
                        {% for prod in recommended_products %}
                        <a href="{% url 'onlineshopfront:product_detail' prod.pk %}"
                            style="width:140px;text-decoration:none;color:inherit">
                            
                            <img src="{% static 'images/coke.png' %}" alt="{{ prod.product_name }}"
                                style="width:100%;height:100px;object-fit:contain;background:#fff;border:1px solid #eee;border-radius:6px" />
                                
                            <div style="font-size:13px;margin-top:6px;font-weight:600">{{ prod.product_name }}</div>
                            <div style="color:#666;font-size:13px">${{ prod.unit_price }}</div>
                        </a>
                        {% endfor %}
                        
                    </div>
                </div>
                {% endif %}
                {% comment %} 
                =================================================
                END: AI "Complete Your Set" SECTION
                =================================================
                {% endcomment %}

            </aside>
        </div>

        {% endif %}
    </div>
</div>

<script>
    // Toggle card fields visibility depending on payment method selection
    document.addEventListener('DOMContentLoaded', function () {
        function updateCardFields() {
            var selected = document.querySelector('input[name="payment_method"]:checked');
            var card = document.getElementById('card-fields');
            if (!selected) { card.style.display = 'none'; return; }
            card.style.display = (selected.value === 'Card') ? 'block' : 'none';
        }
        document.querySelectorAll('input[name="payment_method"]').forEach(function (el) {
            el.addEventListener('change', updateCardFields);
        });
        updateCardFields();
    });
</script>

{% endblock %}